
{% block panel %}
    <div id="mirador"
         data-mirador-url="{{ file.record.links.self_iiif_manifest }}"
         data-canvas-url="{{ file.data.links.iiif_canvas }}"
    ></div>

    <script src="{{ url_for('static', filename='js/mirador-3.min.js') }}"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const miradorElement = document.getElementById("mirador");
            const manifestUrl = miradorElement.getAttribute("data-mirador-url");
            const canvasUrl = miradorElement.getAttribute("data-canvas-url");

            const viewer = Mirador.viewer({
                id: "mirador",
                theme: {
                    transitions: {},
                },
                window: {
                    allowWindowSideBar: false,
                    sideBarOpen: true,
                    sideBarPanel: '',
                },
                windows: [
                    {
                        allowClose: false,
                        manifestId: manifestUrl,
                        canvasId: canvasUrl
                    }
                ],
                workspace: {
                    type: 'not-mosaic-or-elastic',
                },
                workspaceControlPanel: {
                    enabled: false,
                },
            });

            const store = viewer.store;

            let previousCanvasId = null;

            store.subscribe(() => {
                const state = store.getState();
                const windowIds = Object.keys(state.windows);
                if (windowIds.length === 0) return;

                const windowId = windowIds[0];
                const currentCanvasId = state.windows[windowId]?.canvasId;

                if (currentCanvasId && currentCanvasId !== previousCanvasId) {
                    console.log("Canvas selected:", currentCanvasId);
                    previousCanvasId = currentCanvasId;

                    const span = window.parent.document.getElementById("preview-file-title");
                    if (span) {
                        span.innerHTML = currentCanvasId.split('/').pop();
                    } else {
                        console.log("Error: Couldn't find title span")
                    }
                }
            });
        });
    </script>
{% endblock %}
